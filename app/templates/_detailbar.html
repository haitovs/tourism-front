{# safe fallbacks when this partial is included without locals #}
{% set _req = request if request is defined else None %}
{% set _path = _path if _path is defined else (_req.url.path if _req else '/') %}
{% set _params = _params if _params is defined else (_req.query_params if _req else {}) %}
{% set q = _params.get('q', '') if _params is not none else '' %}

<header id="site-header" class="detailbar relative z-detail" x-data="{
        mobileOpen:false,
        init() {
            const closeOnWide = () => {
                if (window.innerWidth >= 1024 && this.mobileOpen) this.mobileOpen = false;
            };
            window.addEventListener('resize', closeOnWide);
        }
    }" :class="{ 'detailbar--drawer-open': mobileOpen }"
    x-effect="document.body.style.overflow = mobileOpen ? 'hidden' : ''">
    <div class="max-w-[var(--container)] mx-auto px-4 row flex items-center justify-between gap-2 sm:gap-4">
        <!-- left: logo -->
        <div class="flex items-center">
            <!-- choose your bar height; h-12 is example -->
            <a href="/" aria-label="Home" class="inline-flex items-center hover:opacity-90 transition h-12">
                <img src="/static/img/detailbar/logo.png" alt="Logo" class="h-full w-auto block pl-px" />
            </a>
        </div>

        <!-- right: email + phone + lang + user -->
        <div class="flex items-center gap-3 sm:gap-4 md:gap-6 min-w-0">
            <!-- email (aggressive truncate on small) -->
            <div class="group hidden xs:flex items-center gap-2 sm:gap-3 min-w-0 max-w-[40vw] sm:max-w-none">
                <img src="/static/img/detailbar/ic-mail.svg"
                    class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 transition-opacity group-hover:opacity-80" alt="" />
                <a href="mailto:info@ciet-turkmenistan.com"
                    class="font-['Roboto'] font-medium text-[12px] sm:text-[16px] md:text-[20px] lg:text-[24px] truncate transition-colors hover:text-[#00B374]"
                    title="info@ciet-turkmenistan.com">
                    info@ciet-turkmenistan.com
                </a>
            </div>

            <!-- phone (truncate hidden on tiny screens) -->
            <div class="group flex items-center gap-2 sm:gap-2.5">
                <img src="/static/img/detailbar/ic-phone.svg"
                    class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 transition-opacity group-hover:opacity-80" alt="" />
                <a href="tel:+99361480080"
                    class="hidden sm:inline font-['Roboto'] font-medium text-[12px] sm:text-[16px] md:text-[20px] lg:text-[24px] transition-colors hover:text-[#00B374]">
                    +99361 480 080
                </a>
            </div>

            <!-- language switcher -->
            <div class="relative" x-data="{
       open:false,
       btnW:0,
       toggle(){ this.open=!this.open; this.$nextTick(()=>{ this.btnW = this.$refs.langBtn?.offsetWidth || 0; }); },
       close(){ this.open=false; },
       init(){ this.btnW = this.$refs.langBtn?.offsetWidth || 0; window.addEventListener('resize', ()=>{ this.btnW = this.$refs.langBtn?.offsetWidth || 0; }); }
     }" @keydown.escape.window="close()" @click.away="close()">
                <button x-ref="langBtn" type="button" class="flex items-center gap-1 font-['Roboto'] font-medium px-2
           text-[12px] sm:text-[16px] md:text-[20px] lg:text-[24px] rounded-md
           hover:bg-white/10 transition-colors" aria-haspopup="menu" :aria-expanded="open.toString()"
                    aria-controls="lang-menu" @click="toggle()">
                    {{ (lang or 'en')|upper }}
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 -rotate-90 transition-transform" :class="open ? 'rotate-0' : ''"
                        viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M6 9l6 6 6-6" stroke="#F4F4F2" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>

                <!-- dropdown -->
                <div id="lang-menu" x-show="open" x-cloak x-transition.origin.top.right
                    class="absolute right-0 top-full mt-1 p-1 glass text-white text-center z-[2000] rounded-md shadow-lg"
                    :style="{ minWidth: (btnW || 0) + 'px' }" role="menu">
                    {% set current = (lang or 'en') %}
                    {% for code in ['en','ru','tk','zh'] %}
                    {% if code == current %}
                    <span class="flex items-center justify-between gap-3 px-3 py-1.5 rounded-md font-medium
                 cursor-default opacity-80" aria-current="true" role="menuitem" tabindex="-1">
                        {{ code|upper }}
                        <!-- checkmark -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" viewBox="0 0 24 24" fill="none"
                            aria-hidden="true">
                            <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </span>
                    {% else %}
                    <a class="block px-3 py-1.5 rounded-md font-medium transition
                 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/60"
                        href="{{ _path }}?lang={{ code }}{% for k,v in _params.items() if k!='lang' %}&{{k}}={{ v|urlencode }}{% endfor %}"
                        role="menuitem" tabindex="0">
                        {{ code|upper }}
                    </a>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>


            <!-- user -->
            <a href="/register" aria-label="Register" class="shrink-0 inline-flex hover:opacity-90 transition">
                <img src="/static/img/detailbar/ic-user.svg"
                    class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 rounded-md hover:bg-white/10" alt="User" />
            </a>

            <button type="button" class="detailbar-mobile-toggle" :class="{ 'is-active': mobileOpen }"
                aria-controls="detailbar-mobile-nav" aria-label="Toggle navigation"
                :aria-expanded="mobileOpen.toString()" @click="mobileOpen = !mobileOpen">
                <span class="detailbar-mobile-toggle__label">Menu</span>
                <svg class="detailbar-mobile-toggle__icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </div>

    <!-- NavPill -->
    {% set p = _path %}
    <div class="pill-rail detailbar-pill-desktop">
        <nav class="navpill navpill--mask px-4 md:px-6">
            <ul class="flex flex-nowrap items-center gap-3 md:gap-6 overflow-x-auto no-scrollbar
               font-['Roboto'] font-bold
               text-[14px] sm:text-[16px] md:text-[18px] lg:text-[22px] xl:text-[22px]
               text-[var(--c-primary)]">

                <li>
                    <a class="hover:text-[var(--c-text)]" href="/">{{ t('nav.home') }}</a>
                </li>

                <li class="relative" x-data="{m:false}" @mouseenter="m=true" @mouseleave="m=false">
                    <button class="flex items-center gap-2 hover:text-[var(--c-text)]" @click.stop="m = !m"
                        @keydown.enter.prevent.stop="m = !m" @keydown.space.prevent.stop="m = !m">
                        {{ t('nav.about_event') }}
                        <img src="/static/img/nav_down_arrow.svg" class="nav-caret" aria-hidden="true">
                    </button>

                    <!-- dropdown (desktop hover) -->
                    <div x-show="m" x-cloak x-transition class="menu-dd" @click.away="m=false"
                        @keydown.escape.window="m=false">
                        <div class="glass menu-panel menu-grid">
                            <div class="menu-items relative">
                                <a href="/about-the-forum" class="menu-item">
                                    <span>{{ t('nav.about_forum') }}</span>
                                </a>

                                <div class="menu-subcard">
                                    <a href="/agenda" class="menu-items-item menu-subitem">{{ t('nav.agenda') }}</a>
                                    <a href="/speakers" class="menu-items-item menu-subitem">{{ t('nav.speakers') }}</a>
                                    <a href="/meeting-request" class="menu-items-item menu-subitem">{{
                                        t('nav.meeting_request') }}</a>
                                </div>
                            </div>

                            <hr class="menu-sep" />
                            <a href="/about-the-expo" class="menu-item">{{ t('nav.about_expo') }}</a>
                            <hr class="menu-sep" />
                            <a href="/official-support" class="menu-item">{{ t('nav.official_support') }}</a>
                            <hr class="menu-sep" />
                            <a href="/brochure" class="menu-item">{{ t('nav.brochure') }}</a>
                        </div>
                    </div>
                </li>

                <li class="relative" x-data="{m:false}" @mouseenter="m=true" @mouseleave="m=false">
                    <button class="flex items-center gap-2 hover:text-[var(--c-text)]" @click.stop="m = !m"
                        @keydown.enter.prevent.stop="m = !m" @keydown.space.prevent.stop="m = !m">
                        {{ t('nav.participants') }}
                        <img src="/static/img/nav_down_arrow.svg" class="nav-caret" aria-hidden="true">
                    </button>
                    <div x-show="m" x-cloak x-transition class="menu-dd" @click.away="m=false"
                        @keydown.escape.window="m=false">


                        <div class="glass menu-panel">
                            <a href="/participants{% if q %}?q={{ q|urlencode }}{% endif %}" class="menu-item">{{
                                t('nav.all') }}</a>
                            <hr class="menu-sep" />
                            <a href="/participants?role=expo{% if q %}&q={{ q|urlencode }}{% endif %}"
                                class="menu-item">{{ t('nav.expo') }}</a>
                            <hr class="menu-sep" />
                            <a href="/participants?role=forum{% if q %}&q={{ q|urlencode }}{% endif %}"
                                class="menu-item">{{ t('nav.forum') }}</a>
                        </div>
                    </div>
                </li>

                <li>
                    <a href="/news"
                        class="{{ 'text-[var(--c-text)]' if p.startswith('/news') else 'hover:text-[var(--c-text)]' }}">{{
                        t('nav.news') }}</a>
                </li>

                <li class="relative" x-data="{m:false}" @mouseenter="m=true" @mouseleave="m=false">
                    <button class="flex items-center gap-2 hover:text-[var(--c-text)]" @click.stop="m = !m"
                        @keydown.enter.prevent.stop="m = !m" @keydown.space.prevent.stop="m = !m">
                        {{ t('nav.travel_guide') }}
                        <img src="/static/img/nav_down_arrow.svg" class="nav-caret" aria-hidden="true">
                    </button>
                    <div x-show="m" x-cloak x-transition class="menu-dd" @click.away="m=false"
                        @keydown.escape.window="m=false">
                        <div class="glass menu-panel">
                            <a href="/visa" class="menu-item">{{ t('nav.apply_visa') }}</a>
                            <hr class="menu-sep" />
                            <a href="/hotel" class="menu-item">{{ t('nav.book_hotel') }}</a>
                            <hr class="menu-sep" />
                            <a href="/flight" class="menu-item">{{ t('nav.book_flight') }}</a>
                            <hr class="menu-sep" />
                            <a href="/faq" class="menu-item">{{ t('nav.faq') }}</a>
                        </div>
                    </div>
                </li>

                <li>
                    <a href="/registration"
                        class="{{ 'text-[var(--c-text)]' if p.startswith('/registration') else 'hover:text-[var(--c-text)]' }}">{{
                        t('nav.registration') }}</a>
                </li>

            </ul>
        </nav>
    </div>

    {% include '_mobile_nav.html' %}
</header>

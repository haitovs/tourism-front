{# app/templates/agenda/_episode_block.html #}
{% import "agenda/_time_badge.html" as tb %}
{% import "agenda/_info_chip.html" as chip %}
{% import "agenda/_speaker_card.html" as card %}
{% import "agenda/_speakers_scroller.html" as scroller %}
{% from "agenda/_sponsor_badge.html" import sponsor_badge %}

{% macro episode_block(d, ep, expanded_var_name) -%}
{% set mod = ep.moderators[0] if ep.moderators else None %}
{% set short = ep.short_desc or '' %}
{% set topic = ep.topic_desc or '' %}
{% set ep_id = ep.id %}
{% set top_sponsor = ep.top_sponsor %}

<article class="grid grid-cols-1 md:grid-cols-[256px_1fr] gap-4 md:gap-5" x-cloak>
    {{ tb.time_badge(ep.start_time, ep.end_time) }}

    <div class="relative bg-white shadow-soft rounded-[20px] p-5 md:p-6">

        {# ===================== MOBILE COLLAPSED ===================== #}
        <div class="md:hidden" x-show="{{ expanded_var_name }} !== {{ ep_id|tojson }}">
            <div class="grid grid-cols-[1fr_auto] items-end gap-4">
                <div class="min-w-0">
                    <h3 class="font-['Montserrat'] font-semibold text-[24px] leading-[28px] text-black">
                        {{ ep.title }}
                    </h3>
                    {% if short %}
                    <p class="mt-3 font-['Roboto'] text-[14px] leading-[18px] text-black">
                        {{ short }}
                    </p>
                    {% endif %}
                </div>

                <div class="flex flex-col items-end justify-between gap-3">
                    {# --- MOBILE SPONSORS (episode-assigned, smaller) --- #}
                    {% if ep.sponsors %}
                    <div class="w-full max-w-[240px]">
                        <div class="text-right font-['Montserrat'] font-semibold text-[12px] leading-[16px] text-black">
                            {{ t('agenda.sponsors') }}
                        </div>
                        <ul class="mt-1.5 flex flex-wrap justify-end items-center gap-1.5"
                            aria-label="{{ t('agenda.sponsors') }}">
                            {% for s in ep.sponsors %}
                            <li class="h-[22px]">
                                {% if s.url %}
                                <a href="{{ s.url }}" target="_blank" rel="noopener noreferrer"
                                    class="inline-flex items-center">
                                    <img src="{{ s.logo_url or '/static/img/logo_placeholder.svg' }}"
                                        alt="{{ s.name or t('sponsor.unknown') }}"
                                        class="h-[22px] w-auto max-w-[84px] object-contain" loading="lazy" />
                                </a>
                                {% else %}
                                <span class="inline-flex items-center">
                                    <img src="{{ s.logo_url or '/static/img/logo_placeholder.svg' }}"
                                        alt="{{ s.name or t('sponsor.unknown') }}"
                                        class="h-[22px] w-auto max-w-[84px] object-contain" loading="lazy" />
                                </span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <button type="button"
                        class="h-[32px] px-5 rounded-[10px] bg-[#007A3D] text-[#F1F1F6] font-['Roboto'] font-bold text-[14px]"
                        @click="{{ expanded_var_name }} = {{ ep_id|tojson }}"
                        x-show="{{ expanded_var_name }} !== {{ ep_id|tojson }}"
                        :aria-expanded="({{ expanded_var_name }} === {{ ep_id|tojson }}) ? 'true' : 'false'">
                        {{ t('common.read_more') }}
                    </button>
                </div>
            </div>
        </div>

        {# ===================== DESKTOP COLLAPSED ===================== #}
        <div class="hidden md:block" x-show="{{ expanded_var_name }} !== {{ ep_id|tojson }}">
            {# COLLAPSED HEADER: title + short, then read more / divider / sponsor #}
            <div class="mt-6 relative flex flex-col xl:flex-row xl:justify-between gap-6">

                <!-- LEFT: Title + Short description -->
                <div class="min-w-0">
                    <h3 class="font-['Montserrat'] font-semibold text-[30px] leading-[37px] text-black">
                        {{ ep.title }}
                    </h3>
                    {% if short %}
                    <p class="mt-4 font-['Roboto'] text-[16px] leading-[20px] text-black max-w-[540px]">
                        {{ short }}
                    </p>
                    {% endif %}
                </div>

                <!-- RIGHT: Read more + divider + sponsor -->
                <div class="flex flex-col xl:flex-row items-end gap-4 xl:gap-6">
                    <button type="button"
                        class="h-[32px] px-5 rounded-[10px] bg-[#007A3D] text-[#F1F1F6] font-['Roboto'] font-bold text-[14px]"
                        @click="{{ expanded_var_name }} = {{ ep_id|tojson }}"
                        x-show="{{ expanded_var_name }} !== {{ ep_id|tojson }}"
                        :aria-expanded="({{ expanded_var_name }} === {{ ep_id|tojson }}) ? 'true' : 'false'">
                        {{ t('common.read_more') }}
                    </button>

                    {% if top_sponsor %}
                    <div class="hidden xl:block w-[2px] h-[125px] bg-[#007A3D] rounded-full"></div>

                    <div class="shrink-0 flex flex-col items-center">
                        {% if top_sponsor.logo_url %}
                        <img src="{{ top_sponsor.logo_url }}" alt="{{ top_sponsor.name or t('sponsor.unknown') }}"
                            class="w-[160px] h-[95px] object-contain" loading="lazy" />
                        {% else %}
                        <img src="/static/img/img_placeholder.png" alt="{{ t('sponsor.unknown') }}"
                            class="w-[160px] h-[95px] object-contain opacity-70" loading="lazy" />
                        {% endif %}

                        {% set tier_key = (top_sponsor.tier or 'gold')|lower %}
                        <div class="mt-2 text-center font-['Roboto'] font-semibold text-[15px] text-[#DDAC17]">
                            {{ t('sponsor.tier.' ~ tier_key) }}
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>

        {# ===================== MOBILE EXPANDED ===================== #}
        <div class="md:hidden" x-show="{{ expanded_var_name }} === {{ ep_id|tojson }}" x-collapse>
            <div class="py-6 flex flex-col gap-6">
                <h3 class="font-['Montserrat'] font-semibold text-[22px] leading-[26px] text-black">
                    {{ ep.title }}
                </h3>

                {% if mod %}
                <div
                    class="m-auto w-full max-w-[980px] grid grid-cols-[88px_1fr] sm:grid-cols-[112px_1fr] gap-4 sm:gap-6 items-center">
                    {# Left: photo #}
                    {% if mod.photo_url %}
                    <div class="shrink-0 w-[88px] sm:w-[112px]">
                        <div
                            class="w-[88px] h-[104px] sm:w-[112px] sm:h-[128px] rounded-[10px] sm:rounded-[12px] overflow-hidden bg-[#F5F5F7] flex items-center justify-center">
                            <img src="{{ mod.photo_url }}" alt="{{ mod.fullname }}"
                                class="h-full w-auto max-w-full object-contain" loading="lazy" />
                        </div>
                    </div>
                    {% else %}
                    <div class="shrink-0 w-[88px] sm:w-[112px]">
                        <div
                            class="w-[88px] h-[104px] sm:w-[112px] sm:h-[128px] rounded-[10px] sm:rounded-[12px] bg-[#F5F5F7]">
                        </div>
                    </div>
                    {% endif %}

                    {# Right (same row): label + name #}
                    <div class="min-w-0">
                        <h3 class="font-['Montserrat'] font-semibold text-[20px] leading-[24px] text-black">
                            {{ t('agenda.moderator') }}
                        </h3>
                        <div class="mt-1 font-['Roboto'] font-bold text-[16px] leading-[20px] text-[#1E1E1E] truncate">
                            {{ mod.fullname }}
                        </div>
                    </div>

                    {# Below (new row, full width): moderator text / fallback #}
                    {% set mdesc = mod.description_norm or '' %}
                    <div class="col-span-2">
                        {% if mdesc %}
                        <div class="mt-2 font-['Roboto'] text-[14px] leading-6 whitespace-pre-line">
                            {{ mdesc }}
                        </div>
                        {% else %}
                        <p class="mt-2 font-['Roboto'] text-[14px] leading-6 text-black">
                            {% if mod.position or mod.company %}
                            {{ mod.position }}{% if mod.company %}, {{ mod.company }}{% endif %}
                            {% else %}
                            &nbsp;
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if topic %}
                <div class="pt-2">
                    <h4 class="font-['Roboto'] font-medium text-[16px] leading-[19px] text-black">{{ t('agenda.topic')
                        }}:</h4>
                    <div class="mt-3 font-['Roboto'] text-[12px] leading-[15px] text-[#1E1E1E] whitespace-pre-line">
                        {{ topic }}
                    </div>
                </div>
                {% endif %}

                {% if ep.speakers %}
                <div class="pt-2">
                    <h4 class="font-['Roboto'] font-medium text-[16px] leading-[19px] text-black">{{
                        t('agenda.speakers') }}:</h4>
                    <ul class="mt-4 space-y-3">
                        {% for sp in ep.speakers %}
                        <li class="flex items-center gap-3">
                            <div class="w-[48px] h-[48px] rounded-full overflow-hidden bg-[#F3F3F6] shrink-0">
                                <img src="{{ sp.photo_url or '/static/img/img_placeholder.png' }}"
                                    alt="{{ sp.fullname }}" class="w-full h-full object-cover" loading="lazy" />
                            </div>
                            <div class="min-w-0">
                                <div
                                    class="font-['Roboto'] font-bold text-[14px] leading-[16px] text-[#1E1E1E] truncate">
                                    {{ sp.fullname }}
                                </div>
                                <div
                                    class="font-['Roboto'] font-semibold text-[12px] leading-[16px] text-[#6C6C6F] truncate">
                                    {{ sp.position }}{% if sp.company %}, {{ sp.company }}{% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div class="mt-4 flex justify-end">
                    <button type="button"
                        class="h-[36px] px-5 rounded-[10px] bg-[#007A3D] text-[#F1F1F6] font-['Roboto'] font-bold text-[14px]"
                        @click="{{ expanded_var_name }} = null" x-show="{{ expanded_var_name }} === {{ ep_id|tojson }}"
                        :aria-expanded="({{ expanded_var_name }} === {{ ep_id|tojson }}) ? 'true' : 'false'">
                        {{ t('common.hide') }}
                    </button>
                </div>
            </div>
        </div>

        {# ===================== DESKTOP EXPANDED ===================== #}
        <div class="hidden md:block" x-show="{{ expanded_var_name }} === {{ ep_id|tojson }}" x-collapse>
            <div class="flex flex-wrap items-center gap-3">
                {{ chip.info_chip('calendar', d.date.strftime('%d %B %Y')) }}
                {% if ep.location %}
                {{ chip.info_chip('map', ep.location) }}
                {% endif %}
            </div>

            <div class="py-10 grid grid-cols-1 gap-8">
                <div class="flex flex-col gap-6">
                    <h3 class="font-['Montserrat'] font-semibold text-[28px] leading-[34px] text-black">
                        {{ ep.title }}
                    </h3>

                    {% if mod %}
                    <div class="m-auto w-full max-w-[980px] flex flex-col md:flex-row items-center gap-6">
                        <div class="flex-1 text-left">
                            <h4 class="font-['Montserrat'] font-semibold text-[20px] leading-[24px] text-black">
                                {{ t('agenda.moderator') }}
                            </h4>
                            {% set mdesc = mod.description_norm or '' %}
                            {% if mdesc %}
                            <div class="mt-2 font-['Roboto'] text-[16px] leading-6 whitespace-pre-line">
                                {{ mdesc }}
                            </div>
                            {% else %}
                            <p class="mt-2 font-['Roboto'] text-[16px] leading-6 text-black">
                                {{ mod.fullname }}
                                {% if mod.position or mod.company %}
                                — {{ mod.position }}{% if mod.company %}, {{ mod.company }}{% endif %}
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>

                        {% if mod.photo_url %}
                        <div class="flex flex-col items-center justify-center shrink-0 w-[140px] md:w-[150px]">
                            <div
                                class="w/[140px] h/[160px] md:w/[150px] md:h/[172px] rounded-[14px] overflow-hidden bg-[#F5F5F7] flex items-center justify-center">
                                <img src="{{ mod.photo_url }}" alt="{{ mod.fullname }}"
                                    class="h-full w-auto max-w-full object-contain" loading="lazy" />
                            </div>
                            <div
                                class="mt-1 text-center font-['Roboto'] text-[13px] font-medium whitespace-normal break-words">
                                {{ mod.fullname }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if topic %}
                    <div>
                        <h4 class="font-['Montserrat'] font-semibold text-[22px] leading-[26px] text-black">
                            {{ t('agenda.topic') }}
                        </h4>
                        <div
                            class="mt-3 font-['Roboto'] text-[16px] leading-6 text-black max-w-[980px] whitespace-pre-line">
                            {{ topic }}
                        </div>
                    </div>
                    {% endif %}

                    {% if ep.speakers %}
                    <section x-data="{ track: null }">
                        <h4 class="font-['Montserrat'] font-semibold text-[22px] leading-[26px] text-black">
                            {{ t('agenda.speakers') }}
                        </h4>
                        <div class="mt-6">
                            <ul x-ref="track" x-init="track = $refs.track"
                                class="no-scrollbar snap-x snap-mandatory overflow-x-auto flex gap-6 pr-2"
                                style="scroll-behavior: smooth" aria-label="{{ t('agenda.speakers_carousel') }}">
                                {% for sp in ep.speakers %}
                                <li class="snap-start shrink-0">
                                    <article
                                        class="relative w-[265px] h-[320px] rounded-[20px] overflow-hidden shadow-lg">
                                        <img src="{{ sp.photo_url or '/static/img/img_placeholder.png' }}"
                                            alt="{{ sp.fullname }}" class="absolute inset-0 w-full h-full object-cover"
                                            loading="lazy" />
                                        <div
                                            class="absolute bottom-0 left-0 right-0 h-[118px] bg-[rgba(30,30,30,0.65)] rounded-b-[20px] p-4">
                                            <div
                                                class="font-['Roboto'] font-bold text-[18px] leading-[21px] text-white truncate">
                                                {{ sp.fullname }}
                                            </div>
                                            <div
                                                class="mt-1 font-['Roboto'] font-normal text-[16px] leading-[19px] text-white line-clamp-2">
                                                {{ sp.position }}{% if sp.company %}, {{ sp.company }}{% endif %}
                                            </div>
                                        </div>
                                        <div class="absolute bottom-4 right-4 w-4 h-4 border border-white rounded-full flex items-center justify-center"
                                            aria-hidden="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                stroke="white" stroke-width="1.5" class="w-3 h-3">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                            </svg>
                                        </div>
                                    </article>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </section>
                    {% endif %}

                    <div class="mt-4 flex justify-end">
                        <button type="button"
                            class="h-[36px] px-5 rounded-[10px] bg-[#007A3D] text-[#F1F1F6] font-['Roboto'] font-bold text-[14px]"
                            @click="{{ expanded_var_name }} = null"
                            x-show="{{ expanded_var_name }} === {{ ep_id|tojson }}"
                            :aria-expanded="({{ expanded_var_name }} === {{ ep_id|tojson }}) ? 'true' : 'false'">
                            {{ t('common.hide') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</article>
{%- endmacro %}
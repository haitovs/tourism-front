<!DOCTYPE html>
<html lang="{{ lang or 'en' }}">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    {# Safely pull request.state.site without Python builtins #}
    {% set _state = (request.state if (request is defined and request and request.state is defined) else none) %}
    {% set _resolved_site = (_state.site if (_state is not none and _state.site is defined and _state.site) else none)
    %}

    <meta name="site-slug"
        content="{{ (site_slug() if site_slug is defined else (_resolved_site.slug if (_resolved_site is defined and _resolved_site and _resolved_site.slug is defined) else '')) }}">
    {% if _resolved_site and _resolved_site.id is defined and _resolved_site.id %}
    <meta name="site-id" content="{{ _resolved_site.id }}">
    {% endif %}
    <title>{{ settings.APP_NAME }}</title>

    <style>
        [x-cloak] {
            display: none !important
        }
    </style>

    <!-- Fonts (self-hosted; files live in /static/fonts) -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/fonts.css') }}?v={{ settings.ASSETS_V or '1' }}">

    <!-- Favicon per site -->
    <link rel="icon" type="image/x-icon" href="{{ theme('img/favicon.ico') }}" />

    <!-- Tailwind FIRST (Preflight + utilities) -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/tw.build.css') }}?v={{ settings.ASSETS_V or '1' }}">

    <!-- Base CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/extra.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/detailbar.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/navpill.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/hero.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/timer.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/sponsors.css') }}" />

    <!-- Per-site overrides AFTER base -->
    <link rel="stylesheet" href="{{ theme('css/theme.css') }}" />
    <link rel="stylesheet" href="{{ theme('css/sponsor.css') }}" />
    <link rel="stylesheet" href="{{ theme('css/detailbar.css') }}" />
    <link rel="stylesheet" href="{{ theme('css/about_the_event.css') }}" />
    <link rel="stylesheet" href="{{ theme('css/statistics.css') }}" />
    <link rel="stylesheet" href="{{ theme('css/footer.css') }}" />

    <!-- Splide CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css" />
</head>

<body class="flex min-h-screen flex-col bg-[var(--c-bg)] text-[var(--c-text)]"
    data-site="{{ (site_slug() if site_slug is defined else (_resolved_site.slug if (_resolved_site is defined and _resolved_site and _resolved_site.slug is defined) else 'main')) }}">
    {% include themed('_detailbar.html') %}
    <div id="detailbar-spacer" aria-hidden="true"></div>
    <main class="flex-1">{% block content %}{% endblock %}</main>
    {% include themed('_footer.html') %}

    <button id="to-top" type="button" aria-label="Scroll to top" title="Back to top" class="sb-top">
        <svg viewBox="0 0 46 46" width="46" height="46" fill="none" aria-hidden="true">
            <path d="M23 35 V11" stroke="#F0F0F0" stroke-width="4" stroke-linecap="round" />
            <path d="M14 20 L23 11 L32 20" stroke="#F0F0F0" stroke-width="4" stroke-linecap="round"
                stroke-linejoin="round" />
        </svg>
    </button>

    <!-- Your JS (defer = non-blocking) -->
    <script src="{{ url_for('static', path='js/marquee.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>
    <script src="{{ url_for('static', path='js/headerHide.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>
    <script src="{{ url_for('static', path='js/scrollTop.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>
    <script src="{{ url_for('static', path='js/timerWidget.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>
    <script src="{{ url_for('static', path='js/countup.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>
    <script src="{{ url_for('static', path='js/participantLoader.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>
    <script src="{{ url_for('static', path='js/agendaScroll.js') }}?v={{ settings.ASSETS_V or '1' }}" defer></script>

    <!-- HTMX / Alpine -->
    <script defer src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script defer src="https://unpkg.com/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.15.1/dist/cdn.min.js"></script>

    <!-- Splide JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>
    <script defer
        src="https://cdn.jsdelivr.net/npm/@splidejs/splide-extension-grid@0.4.1/dist/js/splide-extension-grid.min.js"></script>

    <script>
        // Splide bootstrap
        window.addEventListener("load", () => {
            if (typeof Splide === "undefined") return;
            document.querySelectorAll(".splide[data-splide]").forEach((el) => {
                const d = el.dataset;
                const count = Number(d.count || "0");
                const cfg = {
                    type: d.type || (count > 1 ? "loop" : "slide"),
                    arrows: false,
                    pagination: false,
                    autoplay: d.autoplay === "true" || (d.autoplay === undefined && count > 1),
                    interval: Number(d.interval || "10000"),
                    pauseOnHover: true,
                    speed: Number(d.speed || "600"),
                    easing: d.easing || "cubic-bezier(0.22,1,0.36,1)",
                    drag: true,
                    gap: d.gap || "1rem",
                };
                if (d.perPage) cfg.perPage = Number(d.perPage);
                if (d.rows || d.cols) {
                    cfg.grid = {
                        rows: Number(d.rows || "1"),
                        cols: Number(d.cols || "1"),
                        gap: { row: d.rowGap || "1rem", col: d.colGap || "1rem" }
                    };
                }
                try { if (d.breakpoints) cfg.breakpoints = JSON.parse(d.breakpoints); } catch { }
                const splide = new Splide(el, cfg);
                if (cfg.grid && window.splide && window.splide.Extensions) splide.mount(window.splide.Extensions);
                else splide.mount();
            });
        });
    </script>
</body>

</html>

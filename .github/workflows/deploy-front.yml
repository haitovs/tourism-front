name: Deploy tourism-front to server1

on:
    push:
        branches: ["main"]
    workflow_dispatch: {}

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Deploy over SSH
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_KEY }}
                  port: ${{ secrets.SSH_PORT || 22 }}
                  script_stop: true
                  command_timeout: 30m
                  script: |
                      set -Eeuo pipefail
                      export SHA="${{ github.sha }}"
                      export BRANCH="${{ github.ref_name }}"
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/server1_front_deploy -o IdentitiesOnly=yes -o StrictHostKeyChecking=accept-new'

                      APP_DIR="/root/apps/tourism-front"
                      if docker compose version >/dev/null 2>&1; then DC="docker compose"; else DC="docker-compose"; fi

                      cd "${APP_DIR}"
                      git fetch --all --prune
                      git checkout -f "${BRANCH}"
                      git reset --hard "${SHA}"

                      # Ensure shared network exists (frontend expects external network "tourism")
                      docker network inspect tourism >/dev/null 2>&1 || docker network create tourism

                      $DC build --pull
                      $DC up -d

                      # Wait for the frontend container to be healthy (uses your compose healthcheck)
                      CID=$($DC ps -q frontend)
                      if [ -z "$CID" ]; then
                        echo "frontend container not found after compose up"
                        $DC ps
                        exit 1
                      fi
                      deadline=$((SECONDS + 180))
                      while [ "$(docker inspect -f '{{.State.Health.Status}}' "$CID")" != "healthy" ]; do
                        if [ $SECONDS -ge $deadline ]; then
                          echo "Timed out waiting for healthcheck"; docker logs "$CID" --tail=200; exit 1
                        fi
                        echo "Waiting for health..."; sleep 3
                      done

                      echo "OK"
